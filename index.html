<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>County Map with Assignments</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 1. Initialize map
    const map = L.map('map').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 10,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 2. Holders for data
    let countyGeo = null;
    let assignments = null;

    // 3. Render when both are loaded
    function tryRenderMap() {
      if (!countyGeo || !assignments) return;

      L.geoJSON(countyGeo, {
        style: feature => {
          const name = feature.properties.NAME.trim().toLowerCase();
          const state = feature.properties.STATE.trim().toLowerCase();
          const match = assignments.find(a =>
            a.county.trim().toLowerCase().replace(' county','') === name &&
            a.state.trim().toLowerCase() === state
          );
          return {
            color: match ? 'red' : 'green',
            weight: 0.5,
            fillOpacity: 0.4
          };
        },
        onEachFeature: (feature, layer) => {
          const name = feature.properties.NAME.trim().toLowerCase();
          const state = feature.properties.STATE.trim().toLowerCase();
          const match = assignments.find(a =>
            a.county.trim().toLowerCase().replace(' county','') === name &&
            a.state.trim().toLowerCase() === state
          );
          if (match) {
            layer.bindPopup(
              `<strong>${match.county}, ${match.state}</strong><br>` +
              `Status: Taken<br>` +
              `${match.owner ? `Owner: ${match.owner}<br>` : ''}` +
              `<a href="${match.link}" target="_blank">Facebook Group</a>`
            );
          } else {
            layer.bindPopup(
              `<strong>${feature.properties.NAME}, ${feature.properties.STATE}</strong><br>` +
              `Status: Open`
            );
          }
        }
      }).addTo(map);
    }

    // 4. Load local GeoJSON file
    fetch('gz_2010_us_050_00_20m.json')
      .then(r => r.json())
      .then(data => {
        countyGeo = data;
        tryRenderMap();
      })
      .catch(console.error);

    // 5. Receive assignments via postMessage
    window.addEventListener('message', event => {
      if (Array.isArray(event.data)) {
        assignments = event.data;
        tryRenderMap();
      }
    });

    // 6. Fire off iframe to getAssignments
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = 'https://script.google.com/macros/s/AKfycbzB3_7QgYPyD8_9L2wBVswCTKthBYJkhfhB_cOJLaXB7byKzs2xStgHACt0g6wlLxc1JA/exec?func=getAssignments';
    document.body.appendChild(iframe);
  </script>
</body>
</html>
