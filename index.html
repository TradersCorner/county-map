<script>
  // 1) U.S. bounds including Alaska & Hawaii
  var usBounds = [[14, -170], [72, -50]];

  // 2) Initialize Leaflet map
  var map = L.map('map', {
    minZoom: 3,
    maxZoom: 10,
    maxBounds: usBounds,
    maxBoundsViscosity: 1.0,
    worldCopyJump: false
  }).setView([37.8, -96], 4);

  L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    {
      noWrap: true,
      maxZoom: 10,
      attribution: '&copy; OpenStreetMap contributors'
    }
  ).addTo(map);

  // 3) Data holders
  var countyGeo = null;
  var assignments = null;

  // 4) Render function
  function tryRenderMap() {
    if (countyGeo === null || assignments === null) {
      return;
    }
    console.log('üé® Rendering', countyGeo.features.length, 'counties with', assignments.length, 'assignments');

    var layer = L.geoJSON(countyGeo, {
      style: function(feature) {
        var name  = feature.properties.NAME.trim().toLowerCase();
        var state = feature.properties.STATE.trim().toLowerCase();
        var match = null;
        for (var i = 0; i < assignments.length; i++) {
          var a = assignments[i];
          if (
            a.county.trim().toLowerCase().replace(' county','') === name &&
            a.state.trim().toLowerCase() === state
          ) {
            match = a;
            break;
          }
        }
        return {
          color: match ? 'red' : 'green',
          weight: 0.5,
          fillOpacity: 0.4
        };
      },
      onEachFeature: function(feature, layer) {
        var name  = feature.properties.NAME.trim().toLowerCase();
        var state = feature.properties.STATE.trim().toLowerCase();
        var match = null;
        for (var i = 0; i < assignments.length; i++) {
          var a = assignments[i];
          if (
            a.county.trim().toLowerCase().replace(' county','') === name &&
            a.state.trim().toLowerCase() === state
          ) {
            match = a;
            break;
          }
        }
        var title = match
          ? (match.county + ', ' + match.state + ' (Taken)')
          : (feature.properties.NAME + ', ' + feature.properties.STATE + ' (Open)');
        var popup = '<strong>' + title + '</strong>';
        if (match && match.link) {
          popup += '<br><a href="' + match.link + '" target="_blank">Facebook Group</a>';
        }
        if (match && match.owner) {
          popup += '<br>Owner: ' + match.owner;
        }
        layer.bindPopup(popup);
      }
    });
    layer.addTo(map);
  }

  // 5) Load counties GeoJSON
  console.log('‚è≥ Fetching counties GeoJSON...');
  fetch('gz_2010_us_050_00_20m.json')
    .then(function(res) {
      if (!res.ok) {
        throw new Error('GeoJSON load failed: ' + res.status);
      }
      return res.json();
    })
    .then(function(data) {
      console.log('‚úÖ countyGeo loaded:', data.features.length, 'features');
      countyGeo = data;
      tryRenderMap();
    })
    .catch(function(err) {
      console.error('‚ùå County GeoJSON error:', err);
    });

  // 6) Listen for assignments via postMessage
  console.log('‚è≥ Waiting for assignments...');
  window.addEventListener('message', function(e) {
    console.log('‚úâÔ∏è message received:', e.data);
    if (Array.isArray(e.data)) {
      console.log('‚úÖ assignments loaded:', e.data.length, 'rows');
      assignments = e.data;
      tryRenderMap();
    }
  });

  // 7) Fire off iframe to fetch assignments
  console.log('‚è≥ Injecting iframe for assignments...');
  var iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  iframe.src =
    'https://script.google.com/macros/s/AKfycbzB3_7QgYPyD8_9L2wBVswCTKthBYJkhfhB_cOJLaXB7byKzs2xStgHACt0g6wlLxc1JA/exec?func=getAssignments';
  document.body.appendChild(iframe);
</script>


