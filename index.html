<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>U.S. County Map</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ─── A) DEFINE U.S. BOUNDS (incl. AK + HI) ────────────────────────────────
    var usBounds = [[14, -170], [72, -50]];

    // ─── B) INITIALIZE MAP ─────────────────────────────────────────────────────
    var map = L.map('map', {
      minZoom: 3,
      maxZoom: 10,
      maxBounds: usBounds,
      maxBoundsViscosity: 1.0,
      worldCopyJump: false
    }).setView([37.8, -96], 4);

    L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        noWrap: true,
        maxZoom: 10,
        attribution: '&copy; OpenStreetMap contributors'
      }
    ).addTo(map);

    // ─── C) DATA HOLDERS ───────────────────────────────────────────────────────
    var countyGeo = null;
    var assignments = null;

    // ─── D) RENDER FUNCTION ────────────────────────────────────────────────────
    function tryRenderMap() {
      if (!countyGeo || !assignments) return;
      console.log('Rendering', countyGeo.features.length, 'counties; assignments:', assignments.length);

      L.geoJSON(countyGeo, {
        style: function(feat) {
          var cName = feat.properties.NAME.trim().toLowerCase();
          var sName = feat.properties.STATE.trim().toLowerCase();
          for (var i = 0; i < assignments.length; i++) {
            var a = assignments[i];
            if (
              a.state.trim().toLowerCase() === sName &&
              a.county.trim().toLowerCase().replace(' county','') === cName
            ) {
              return { color:'red', weight:0.5, fillOpacity:0.4 };
            }
          }
          return { color:'green', weight:0.5, fillOpacity:0.4 };
        },
        onEachFeature: function(feat, layer) {
          var cName = feat.properties.NAME.trim().toLowerCase();
          var sName = feat.properties.STATE.trim().toLowerCase();
          var popup = '<strong>' + feat.properties.NAME + ', ' + feat.properties.STATE + '</strong><br>Status: Open';
          for (var i = 0; i < assignments.length; i++) {
            var a = assignments[i];
            if (
              a.state.trim().toLowerCase() === sName &&
              a.county.trim().toLowerCase().replace(' county','') === cName
            ) {
              popup = '<strong>' + a.county + ', ' + a.state + '</strong><br>Status: Taken';
              if (a.owner) popup += '<br>Owner: ' + a.owner;
              if (a.link)  popup += '<br><a href="' + a.link + '" target="_blank">Facebook Group</a>';
              break;
            }
          }
          layer.bindPopup(popup);
        }
      }).addTo(map);
    }

    // ─── E) LOAD COUNTY GEOJSON ──────────────────────────────────────────────────
    console.log('Loading county shapes…');
    fetch('gz_2010_us_050_00_20m.json')
      .then(function(res) {
        if (!res.ok) throw new Error('GeoJSON load failed: ' + res.status);
        return res.json();
      })
      .then(function(data) {
        console.log('Loaded counties:', data.features.length);
        countyGeo = data;
        tryRenderMap();
      })
      .catch(function(err) {
        console.error('County GeoJSON error:', err);
      });

    // ─── F) JSONP CALLBACK ─────────────────────────────────────────────────────
    function assignmentsLoaded(data) {
      console.log('Assignments (JSONP) loaded:', data.length, 'rows');
      assignments = data;
      tryRenderMap();
    }

    // ─── G) INJECT JSONP SCRIPT TAG ─────────────────────────────────────────────
    console.log('Requesting assignments via JSONP…');
    (function() {
      var s = document.createElement('script');
      s.src = 'https://script.google.com/macros/s/AKfycbzB3_7QgYPyD8_9L2wBVswCTKthBYJkhfhB_cOJLaXB7byKzs2xStgHACt0g6wlLxc1JA/exec'
            + '?func=getAssignments'
            + '&callback=assignmentsLoaded';
      document.head.appendChild(s);
    })();
  </script>
</body>
</html>

