<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>County Map Status</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 10,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let countyData = null;
    let assignments = null;

    function tryRenderMap() {
      if (!countyData || !assignments) return;

      const styledLayer = L.geoJSON(countyData, {
        style: feature => {
          const countyName = feature.properties.NAME.trim().toLowerCase();
          const stateName = feature.properties.STATE_NAME.trim().toLowerCase(); // Adjust if using STATE instead

          const match = assignments.find(a =>
            a.county.toLowerCase().includes(countyName) &&
            a.state.toLowerCase() === stateName
          );

          return {
            color: match ? 'red' : 'green',
            weight: 0.5,
            fillOpacity: 0.5
          };
        },
        onEachFeature: (feature, layer) => {
          const countyName = feature.properties.NAME.trim().toLowerCase();
          const stateName = feature.properties.STATE_NAME.trim().toLowerCase();

          const match = assignments.find(a =>
            a.county.toLowerCase().includes(countyName) &&
            a.state.toLowerCase() === stateName
          );

          if (match) {
            layer.bindPopup(`
              <strong>${match.county}, ${match.state}</strong><br>
              Status: Taken<br>
              ${match.owner ? `Owner: ${match.owner}<br>` : ''}
              <a href="${match.link}" target="_blank">Facebook Group</a>
            `);
          } else {
            layer.bindPopup(`<strong>${feature.properties.NAME}, ${feature.properties.STATE_NAME}</strong><br>Status: Open`);
          }
        }
      });

      styledLayer.addTo(map);
    }

    // Handle postMessage data from Apps Script
    window.addEventListener("message", (event) => {
      const msg = event.data;
      if (msg && typeof msg === 'object') {
        if (msg.type === 'FeatureCollection') {
          countyData = msg;
        } else if (Array.isArray(msg)) {
          assignments = msg;
        }
        tryRenderMap();
      }
    });

    // Load both datasets via iframe
    const base = 'https://script.google.com/macros/s/PASTE_YOUR_DEPLOYED_ID_HERE/exec';
    const geoFrame = document.createElement("iframe");
    geoFrame.style.display = "none";
    geoFrame.src = base + '?func=getGeoJSON';
    document.body.appendChild(geoFrame);

    const assignFrame = document.createElement("iframe");
    assignFrame.style.display = "none";
    assignFrame.src = base + '?func=getAssignments';
    document.body.appendChild(assignFrame);
  </script>
</body>
</html>
