<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>County Map Status</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([37.8, -96], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 10,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let countyData = null;
    let assignments = null;

    function tryRenderMap() {
      if (!countyData || !assignments) return;

      const styledLayer = L.geoJSON(countyData, {
        style: feature => {
          const countyName = feature.properties.NAME.trim().toLowerCase();
          const stateCode = feature.properties.STATE.trim().toLowerCase(); // uses "AL", "TX", etc.

          const match = assignments.find(a =>
            a.county.toLowerCase().replace(' county', '') === countyName &&
            a.state.toLowerCase() === stateCode
          );

          return {
            color: match ? 'red' : 'green',
            weight: 0.5,
            fillOpacity: 0.5
          };
        },
        onEachFeature: (feature, layer) => {
          const countyName = feature.properties.NAME.trim().toLowerCase();
          const stateCode = feature.properties.STATE.trim().toLowerCase();

          const match = assignments.find(a =>
            a.county.toLowerCase().replace(' county', '') === countyName &&
            a.state.toLowerCase() === stateCode
          );

          if (match) {
            layer.bindPopup(`
              <strong>${match.county}, ${match.state}</strong><br>
              Status: Taken<br>
              ${match.owner ? `Owner: ${match.owner}<br>` : ''}
              ${match.link ? `<a href="${match.link}" target="_blank">Facebook Group</a>` : ''}
            `);
          } else {
            layer.bindPopup(`<strong>${feature.properties.NAME}, ${feature.properties.STATE}</strong><br>Status: Open`);
          }
        }
      });

      styledLayer.addTo(map);
    }

    window.addEventListener("message", (event) => {
      const msg = event.data;
      if (msg && typeof msg === 'object') {
        if (msg.type === 'FeatureCollection') {
          console.log("✅ GeoJSON loaded:", msg.features.length, "features");
          countyData = msg;
        } else if (Array.isArray(msg)) {
          console.log("✅ Assignments loaded:", msg.length, "rows");
          assignments = msg;
        }
        tryRenderMap();
      }
    });

    const base = 'https://script.google.com/macros/s/AKfycbzB3_7QgYPyD8_9L2wBVswCTKthBYJkhfhB_cOJLaXB7byKzs2xStgHACt0g6wlLxc1JA/exec';

    const iframe1 = document.createElement("iframe");
    iframe1.style.display = "none";
    iframe1.src = base + '?func=getGeoJSON';
    document.body.appendChild(iframe1);

    const iframe2 = document.createElement("iframe");
    iframe2.style.display = "none";
    iframe2.src = base + '?func=getAssignments';
    document.body.appendChild(iframe2);
  </script>
</body>
</html>

