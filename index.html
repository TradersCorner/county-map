<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>U.S. County Map</title>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 1) static bounds covering ALL US (incl. AK + HI)
    const usBounds = [
      [14,  -170],  // SW: a bit below Hawaii
      [72,   -50]   // NE: a bit east of Maine
    ];

    // 2) init map, always locked to those bounds
    const map = L.map('map', {
      minZoom: 3,              // zoom out enough to see AK & HI
      maxZoom: 10,             // limit how far you can zoom in
      maxBounds: usBounds,     // restrict panning
      maxBoundsViscosity: 1.0, // “stick” to the edges
      worldCopyJump: false
    }).setView([37.8, -96], 4);

    // 3) base tiles, no wrapping
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      noWrap: true,
      maxZoom: 10,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 4) placeholders
    let countyGeo = null, assignments = null;

    // 5) render once both are loaded
    function tryRenderMap() {
      if (!countyGeo || !assignments) return;
      L.geoJSON(countyGeo, {
        style: f => {
          const c = f.properties.NAME.trim().toLowerCase();
          const s = f.properties.STATE.trim().toLowerCase();
          const m = assignments.find(a =>
            a.county.trim().toLowerCase().replace(' county','') === c &&
            a.state.trim().toLowerCase() === s
          );
          return { color: m ? 'red' : 'green', weight:0.5, fillOpacity:0.4 };
        },
        onEachFeature: (f, layer) => {
          const c = f.properties.NAME.trim().toLowerCase();
          const s = f.properties.STATE.trim().toLowerCase();
          const m = assignments.find(a =>
            a.county.trim().toLowerCase().replace(' county','') === c &&
            a.state.trim().toLowerCase() === s
          );
          if (m) {
            layer.bindPopup(
              `<strong>${m.county}, ${m.state}</strong><br>` +
              `Status: Taken<br>` +
              `${m.owner?`Owner: ${m.owner}<br>`:''}` +
              `<a href="${m.link}" target="_blank">Facebook Group</a>`
            );
          } else {
            layer.bindPopup(
              `<strong>${f.properties.NAME}, ${f.properties.STATE}</strong><br>` +
              `Status: Open`
            );
          }
        }
      }).addTo(map);
    }

    // 6) load local county GeoJSON
    fetch('gz_2010_us_050_00_20m.json')
      .then(r => r.json())
      .then(data => { countyGeo = data; tryRenderMap(); })
      .catch(console.error);

    // 7) receive assignments via iframe postMessage
    window.addEventListener('message', e => {
      if (Array.isArray(e.data)) {
        assignments = e.data;
        tryRenderMap();
      }
    });

    // 8) fire iframe to fetch assignment data
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src =
      'https://script.google.com/macros/s/AKfycbzB3_7QgYPyD8_9L2wBVswCTKthBYJkhfhB_cOJLaXB7byKzs2xStgHACt0g6wlLxc1JA/exec?func=getAssignments';
    document.body.appendChild(iframe);
  </script>
</body>
</html>

