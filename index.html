<script>
  // ─── 1) Define U.S. bounds (incl. AK + HI) ─────────────────────────────────
  const usBounds = [
    [14,  -170],  // SW: a bit south of Hawaii
    [72,   -50]   // NE: a bit east of Maine
  ];

  // ─── 2) Init map, locked to those bounds ──────────────────────────────────
  const map = L.map('map', {
    minZoom: 3,
    maxZoom: 10,
    maxBounds: usBounds,
    maxBoundsViscosity: 1.0,
    worldCopyJump: false
  }).setView([37.8, -96], 4);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    noWrap: true,
    maxZoom: 10,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // ─── 3) Data holders ──────────────────────────────────────────────────────
  let countyGeo = null;
  let assignments = null;

  // ─── 4) Render when ready ─────────────────────────────────────────────────
  function tryRenderMap() {
    if (!countyGeo || !assignments) return;
    console.log('🎨 Rendering map with', countyGeo.features.length, 'counties and', assignments.length, 'assignments');

    L.geoJSON(countyGeo, {
      style: f => {
        const c = f.properties.NAME.trim().toLowerCase();
        const s = f.properties.STATE.trim().toLowerCase();
        const m = assignments.find(a =>
          a.county.trim().toLowerCase().replace(' county','') === c &&
          a.state.trim().toLowerCase() === s
        );
        return { color: m ? 'red' : 'green', weight:0.5, fillOpacity:0.4 };
      },
      onEachFeature: (f, layer) => {
        const c = f.properties.NAME.trim().toLowerCase();
        const s = f.properties.STATE.trim().toLowerCase();
        const m = assignments.find(a =>
          a.county.trim().toLowerCase().replace(' county','') === c &&
          a.state.trim().toLowerCase() === s
        );
        const title = m
          ? `${m.county}, ${m.state} (Taken)`
          : `${f.properties.NAME}, ${f.properties.STATE} (Open)`;
        let popup = `<strong>${title}</strong>`;
        if (m && m.link) popup += `<br><a href="${m.link}" target="_blank">Facebook Group</a>`;
        if (m && m.owner) popup += `<br>Owner: ${m.owner}`;
        layer.bindPopup(popup);
      }
    }).addTo(map);
  }

  // ─── 5) Load county GeoJSON ─────────────────────────────────────────────────
  console.log('⏳ Fetching county GeoJSON...');
  fetch('gz_2010_us_050_00_20m.json')
    .then(res => {
      if (!res.ok) throw new Error('GeoJSON load failed: ' + res.status);
      return res.json();
    })
    .then(data => {
      console.log('✅ countyGeo loaded:', data.features.length, 'features');
      countyGeo = data;
      tryRenderMap();
    })
    .catch(err => console.error('❌ County GeoJSON load error:', err));

  // ─── 6) Listen for assignment data ────────────────────────────────────────
  window.addEventListener('message', ev => {
    console.log('✉️ postMessage received:', ev.data);
    if (Array.isArray(ev.data)) {
      console.log('✅ assignments loaded:', ev.data.length, 'rows');
      assignments = ev.data;
      tryRenderMap();
    }
  });

  // ─── 7) Fire off iframe to fetch assignments ───────────────────────────────
  console.log('⏳ Requesting assignments via iframe...');
  const iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  iframe.src = 'https://script.google.com/macros/s/AKfycbzB3_7QgYPyD8_9L2wBVswCTKthBYJkhfhB_cOJLaXB7byKzs2xStgHACt0g6wlLxc1JA/exec?func=getAssignments';
  document.body.appendChild(iframe);
</script>


