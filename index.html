<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>U.S. County Map</title>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ─── A) U.S. bounds incl. AK+HI ──────────────────────────────────────────
    var usBounds = [[14, -170], [72, -50]];

    // ─── B) Init Leaflet map ─────────────────────────────────────────────────
    var map = L.map('map', {
      minZoom: 3, maxZoom: 10,
      maxBounds: usBounds, maxBoundsViscosity: 1.0,
      worldCopyJump: false
    }).setView([37.8, -96], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      noWrap: true, maxZoom: 10,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ─── C) Holders ────────────────────────────────────────────────────────────
    var countyGeo = null, assignments = null;

    // ─── D) Render when ready ──────────────────────────────────────────────────
    function tryRenderMap() {
      if (!countyGeo || !assignments) return;
      console.log('Rendering', countyGeo.features.length, 'counties with', assignments.length, 'assignments');
      L.geoJSON(countyGeo, {
        style: function(f) {
          var c = f.properties.NAME.toLowerCase().replace(' county','').trim();
          var s = f.properties.STATE.toLowerCase().trim();
          var taken = assignments.some(a =>
            a.state.toLowerCase().trim() === s &&
            a.county.toLowerCase().replace(' county','').trim() === c
          );
          return { color: taken?'red':'green', weight:0.5, fillOpacity:0.4 };
        },
        onEachFeature: function(f, layer) {
          var name = f.properties.NAME + ', ' + f.properties.STATE;
          var c = f.properties.NAME.toLowerCase().replace(' county','').trim();
          var s = f.properties.STATE.toLowerCase().trim();
          var a = assignments.find(a =>
            a.state.toLowerCase().trim() === s &&
            a.county.toLowerCase().replace(' county','').trim() === c
          );
          var popup = '<strong>' + name + '</strong><br>Status: ' + (a?'Taken':'Open');
          if (a) {
            if (a.owner) popup += '<br>Owner: ' + a.owner;
            if (a.link)  popup += '<br><a href="' + a.link + '" target="_blank">Facebook Group</a>';
          }
          layer.bindPopup(popup);
        }
      }).addTo(map);
    }

    // ─── E) Load county GeoJSON ─────────────────────────────────────────────────
    console.log('Loading counties…');
    fetch('gz_2010_us_050_00_20m.json')
      .then(r => r.json())
      .then(g => { countyGeo = g; console.log('Counties loaded:', g.features.length); tryRenderMap(); });

    // ─── F) JSONP callback ─────────────────────────────────────────────────────
    function assignmentsLoaded(data) {
      assignments = data;
      console.log('Assignments loaded:', data.length);
      tryRenderMap();
    }

    // ─── G) Inject JSONP <script> ───────────────────────────────────────────────
    console.log('Requesting assignments via JSONP…');
    (function(){
      var s = document.createElement('script');
      s.src = 'https://script.google.com/macros/s/AKfycbzB3_7QgYPyD8_9L2wBVswCTKthBYJkhfhB_cOJLaXB7byKzs2xStgHACt0g6wlLxc1JA/exec'
            + '?func=getAssignments'
            + '&callback=assignmentsLoaded';
      document.head.appendChild(s);
    })();
  </script>
</body>
</html>


