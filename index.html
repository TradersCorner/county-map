<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>U.S. County Map</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 1. Define continental U.S. bounds
    const usBounds = [
      [24.396308, -124.848974],  // SW corner
      [49.384358,  -66.885444]   // NE corner
    ];

    // 2. Initialize the map (no hard maxBounds yet)
    const map = L.map('map', {
      minZoom: 4,
      maxZoom: 10,
      worldCopyJump: false
    }).setView([37.8, -96], 4);

    // 3. Add OSM tiles without global wrapping
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      noWrap: true,
      maxZoom: 10,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 4. Toggle bounds only when zoomed out
    function updateBounds() {
      if (map.getZoom() <= 6) {
        map.setMaxBounds(usBounds);
      } else {
        map.setMaxBounds(null);
      }
    }
    map.on('zoomend', updateBounds);
    // apply initial bounds
    updateBounds();

    // 5. Data holders
    let countyGeo = null;
    let assignments = null;

    // 6. Render counties when both datasets are ready
    function tryRenderMap() {
      if (!countyGeo || !assignments) return;

      L.geoJSON(countyGeo, {
        style: feature => {
          const name  = feature.properties.NAME.trim().toLowerCase();
          const state = feature.properties.STATE.trim().toLowerCase();
          const match = assignments.find(a =>
            a.county.trim().toLowerCase().replace(' county','') === name &&
            a.state.trim().toLowerCase() === state
          );
          return {
            color: match ? 'red' : 'green',
            weight: 0.5,
            fillOpacity: 0.4
          };
        },
        onEachFeature: (feature, layer) => {
          const name  = feature.properties.NAME.trim().toLowerCase();
          const state = feature.properties.STATE.trim().toLowerCase();
          const match = assignments.find(a =>
            a.county.trim().toLowerCase().replace(' county','') === name &&
            a.state.trim().toLowerCase() === state
          );
          if (match) {
            layer.bindPopup(
              `<strong>${match.county}, ${match.state}</strong><br>` +
              `Status: Taken<br>` +
              `${match.owner ? `Owner: ${match.owner}<br>` : ''}` +
              `<a href="${match.link}" target="_blank">Facebook Group</a>`
            );
          } else {
            layer.bindPopup(
              `<strong>${feature.properties.NAME}, ${feature.properties.STATE}</strong><br>` +
              `Status: Open`
            );
          }
        }
      }).addTo(map);
    }

    // 7. Load local county GeoJSON
    fetch('gz_2010_us_050_00_20m.json')
      .then(res => res.json())
      .then(data => {
        countyGeo = data;
        tryRenderMap();
      })
      .catch(err => console.error('County GeoJSON load error:', err));

    // 8. Listen for assignment data via postMessage
    window.addEventListener('message', event => {
      if (Array.isArray(event.data)) {
        assignments = event.data;
        tryRenderMap();
      }
    });

    // 9. Fire off iframe to fetch getAssignments()
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = 'https://script.google.com/macros/s/AKfycbzB3_7QgYPyD8_9L2wBVswCTKthBYJkhfhB_cOJLaXB7byKzs2xStgHACt0g6wlLxc1JA/exec?func=getAssignments';
    document.body.appendChild(iframe);
  </script>
</body>
</html>

