<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Territory Coverage Map</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
    .info {
      position:absolute; top:10px; right:10px;
      background:rgba(0,0,0,0.75); color:#fff;
      padding:10px; border-radius:6px; font:14px sans-serif;
      z-index:1000; min-width:200px;
    }
    .info h4 { margin:0 0 8px; }
    .info a  { color:#0af; text-decoration:underline; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const stateNames = {
      '01':'Alabama','02':'Alaska','04':'Arizona','05':'Arkansas','06':'California',
      '08':'Colorado','09':'Connecticut','10':'Delaware','11':'DC','12':'Florida',
      '13':'Georgia','15':'Hawaii','16':'Idaho','17':'Illinois','18':'Indiana','19':'Iowa',
      '20':'Kansas','21':'Kentucky','22':'Louisiana','23':'Maine','24':'Maryland','25':'Massachusetts',
      '26':'Michigan','27':'Minnesota','28':'Mississippi','29':'Missouri','30':'Montana','31':'Nebraska',
      '32':'Nevada','33':'New Hampshire','34':'New Jersey','35':'New Mexico','36':'New York','37':'North Carolina',
      '38':'North Dakota','39':'Ohio','40':'Oklahoma','41':'Oregon','42':'Pennsylvania','44':'Rhode Island',
      '45':'South Carolina','46':'South Dakota','47':'Tennessee','48':'Texas','49':'Utah','50':'Vermont',
      '51':'Virginia','53':'Washington','54':'West Virginia','55':'Wisconsin','56':'Wyoming'
    };

    window.addEventListener('load', () => {
      // 1) get assignments
      google.script.run.withSuccessHandler(assignments => {
        const lookup = {};
        assignments.forEach(a => lookup[`${a.state}|${a.county}`] = a);

        // 2) get GeoJSON
        google.script.run.withSuccessHandler(geoStr => {
          const geo = JSON.parse(geoStr);
          renderMap(geo, lookup);
        }).getGeoJSON();
      }).getAssignments();
    });

    function renderMap(geo, lookup) {
      const map = L.map('map').setView([37.8, -96], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      const info = L.control();
      info.onAdd = () => {
        const div = L.DomUtil.create('div','info');
        div.innerHTML = '<h4>County Info</h4>Click a county';
        return div;
      };
      info.addTo(map);

      L.geoJSON(geo, {
        style: f => {
          const st  = stateNames[f.properties.STATEFP];
          const key = `${st}|${f.properties.NAME}`;
          return {
            fillColor: lookup[key]?.status==='Taken' ? '#0f0' : '#f00',
            weight: 1, color: '#333', fillOpacity: 0.7
          };
        },
        onEachFeature: (f, layer) => {
          layer.on('click', () => {
            const st = stateNames[f.properties.STATEFP];
            const cn = f.properties.NAME;
            const a  = lookup[`${st}|${cn}`] || {};
            info.getContainer().innerHTML =
              `<h4>${cn}, ${st}</h4>` +
              `Status: ${a.status||'Open'}<br>` +
              `Owner: ${a.owner||'â€”'}<br>` +
              (a.link
                ? `Link: <a href="${a.link}" target="_blank">Visit Group</a>`
                : 'Link: None');
          });
        }
      }).addTo(map);
    }
  </script>
</body>
</html>
